[TOC]

# 药品目录

## 用户输入

|列名|定义|代号|
|-|-|-|
|drug_genname_code|目标药品名|$d_i$|
|drug_pric|单价|$p_i$|
|nw_userat|新增使用率|$rn_i$|
|comp_eoc|竞品转化率|$rc_i$|

## 疾病及竞品参数

每个药品对应有其竞品，以及对应的疾病。

## 经验参数

### 就诊参数

对于满足目标疾病以及目标年份的明细数据做以下表格：

|列名|定义|代号|
|-|-|-|
|poolarea|区域代码，加和维度|$a$|
|medinslv|医院等级（1:一级，2:二级，3:三级），加和维度|$h$|
|mdtrt_type|就诊类型（1:门诊，2:住院），加和维度|$t$|
|drug_genname_codg|药品名，加和维度|$d$|
|psn_cnt|该维度下<code>count(distinct(psn_code))</code>，即以上维度服务的人数|$n(a,h,t,d)$|
|drug_act_useamt|药品用量，以上维度下的加和值|$m(a,h,t,d)$|
|med_fee|总医疗费用，以上维度下的加和值|$\alpha(a,h,t,d)$|
|hi_scp_in_fee|范围内总费用，以上维度下的加和值|$\beta(a,h,t,d)$|

### 人员参数

另外，为计算人均费用以便前端输出，需要对不同维度下人数做统计：

|列名|定义|代号|
|-|-|-|
|poolarea|区域代码，加和维度|$a$|
|medinslv|医院等级（1:一级，2:二级，3:三级，4:全部），加和维度|$h$|
|mdtrt_type|就诊类型（1:门诊，2:住院，3:全部），加和维度|$t$|
|psn_cnt|该维度下<code>count(distinct(psn_code))</code>，即以上维度下用药人数|$n(a,h,t)$|

## 计算逻辑

### 前提定义

定义所有目标药品集合 $D=\{d_1,...,d_n\}$ 某种目标药品 $d_i$ 其竞品编码集合 $C_i=\{c_{i1},...,c_{ik_i}\}$ ，其其他药品码集合 $O_i=\{o_{i1},...,o_{il_i}\}$

根据[就诊参数](#就诊参数)表格逐行计算其对应维度在药品目录变更后的用药人数($n'(a,h,t,d)$)，用药数量($m'(a,h,t,d)$)以及总费用($\alpha'(a,h,t,d)$)和范围内费用($\beta'(a,h,t,d)$)

### 用药人员转

由于目标药品存在相互干涉（即 $d_1,d_2$ 互为竞品关系），故可采用马尔可夫过程模拟干涉情况，或不考虑干涉情况（计算结果会因不同的计算顺序而影响）。

#### 马尔可夫过程

在假设每个用药人为单独个体，且年内转移是泊松过程（转移密度不随时间变化而变化）的基础上，进行马尔可夫转移密度矩阵计算 

定义状态集合为 $K=D\cup\left(\bigcup_{i=1}^nC_i\right)\cup\left(\bigcup_{i=1}^nO_i\right)$ 为方便表述，将集合表述为 $K=\{k_1,...,k_m\}$  

定义转移密度矩阵 $A=\{a_{ij}\}$ ，其中 $a_{ij}$ 是从药品 $k_i$ 到药品 $k_j$ 的转移概率密度。

根据[证明](#马尔可夫证明)得，当 $i\ne j$ 时 $a_{ij}=\begin{cases}-\ln(1-rc_i)&k_i\in\bigcup_{i=1}^nC_i\land k_j\in D\\-\ln(1-rn_i)&k_i\in\bigcup_{i=1}^nO_i\land k_j\in D\\0&else\end{cases}$ ，而 $a_{ii}=1-\sum_{j\ne i}a_{ij}$

同样根据计算完成的概率密度矩阵，计算转移概率矩阵，根据[证明](#马尔可夫证明)得公式为 $P(t)=e^{At}=\sum_{u=0}^\infty\frac{1}{u!}A^ut^u$

采用 $1$ 为时间单位，故得 $P(1)=\sum_{u=1}^\infty\frac{1}{u!}A^u$ 根据精度需要计算，一般计算至 $10!$ 即可。

故转移用药人员在同样地区，医院等级，医疗类型下可根据马尔可夫矩阵 $P(1)$ 计算。

#### 不考虑干涉

根据[就诊参数表格](#就诊参数)行计算：

1. 未经操作时 $n'(a,h,t,d)=n(a,h,t,d)$
2. 按 $i=1,2...$ 依次对比是否 $d\in C_i$ ，若是，则该行人数 $n'(a,h,t,d)=n(a,h,t,d)(1-rc_i)$ 
   同时 $n'(a,h,t,d_i)=n'(a,h,t,d_i)+n(a,h,t,d)rc_i$
3. 按 $i=1,2...$ 依次对比是否 $d\in O_i$ ，若是，则该行人数 $n'(a,h,t,d)=n(a,h,t,d)(1-rn_i)$ 
   同时 $n'(a,h,t,d_i)=n'(a,h,t,d_i)+n(a,h,t,d)rn_i$

### 费用计算

根据[就诊参数表格](#就诊参数)行计算：

1. 若 $d\not\in D$ 则其总费用为 $\alpha'(a,h,t,d)=n'(a,h,t,d)*\frac{\alpha(a,h,t,d)}{n(a,h,t,d)}$
2. 若 $d\in D$ 则其总费用为 $\alpha'(a,h,t,d)=n'(a,h,t,d)*p_i*m(a,h,t,d)$
3. 保障内费用为 $\beta'(a,h,t,d)=\alpha'(a,h,t,d)\frac{\beta(a,h,t,d)}{\alpha(a,h,t,d)}$

### 结果聚合

根据上述计算结果，在区域代码、医院等级、就诊类型维度对改变前总医疗费用、改变前范围内总费用、改变后总医疗费用以及改变后范围内总费用做行聚合。

聚合完成后根据[人员参数](#人员参数)中的人数填入“hc”列作为结果输出。

## 模型输出

|列名|定义|代号|
|-|-|-|
|poolarea|区域代码|$a$|
|medinslv|医院等级（1:一级，2:二级，3:三级，4:全部）|$h'$|
|mdtrt_type|就诊类型（1:门诊，2:住院，3:全部）|$t'$|
|bf_med_fee|改变前总医疗费用|$\alpha$|
|bf_scp_fee|改变前范围内总费用|$\beta$|
|af_med_fee|改变后总医疗费用|$\alpha'$|
|af_scp_fee|改变后范围内总费用|$\beta'$|
|hc|人数|

# 马尔可夫证明